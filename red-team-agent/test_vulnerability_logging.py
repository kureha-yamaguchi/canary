#!/usr/bin/env python3
"""Test script to verify vulnerability logging to Supabase works"""
import os
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent))

from vulnerability_logger import log_sql_injection_attempt, log_vulnerability_to_supabase
from config import Config

def test_supabase_connection():
    """Test if Supabase is configured"""
    supabase_url = os.getenv("SUPABASE_URL")
    supabase_key = os.getenv("SUPABASE_SERVICE_ROLE_KEY")
    
    print("=" * 60)
    print("Testing Supabase Vulnerability Logging")
    print("=" * 60)
    print()
    
    if not supabase_url:
        print("‚ùå SUPABASE_URL not set in environment")
        return False
    
    if not supabase_key:
        print("‚ùå SUPABASE_SERVICE_ROLE_KEY not set in environment")
        return False
    
    print(f"‚úì SUPABASE_URL: {supabase_url[:30]}...")
    print(f"‚úì SUPABASE_SERVICE_ROLE_KEY: {'*' * 20}...")
    print()
    
    return True

def test_sql_injection_logging():
    """Test logging a SQL injection attempt"""
    print("Testing SQL Injection Logging...")
    print("-" * 60)
    
    test_url = "http://localhost:3001/api/search"
    test_payload = "' OR '1'='1"
    
    print(f"URL: {test_url}")
    print(f"Payload: {test_payload}")
    print(f"Method: POST")
    print(f"Parameter: username")
    print()
    
    result = log_sql_injection_attempt(
        url=test_url,
        payload=test_payload,
        method="POST",
        parameter="username",
        success=True,
        response_indicators=["injection detected", "warning"]
    )
    
    if result:
        print("‚úÖ Successfully logged SQL injection attempt to Supabase!")
        print()
        return True
    else:
        print("‚ùå Failed to log SQL injection attempt")
        print("   Check your Supabase configuration and network connection")
        print()
        return False

def test_generic_vulnerability_logging():
    """Test logging a generic vulnerability"""
    print("Testing Generic Vulnerability Logging...")
    print("-" * 60)
    
    test_url = "http://localhost:3001"
    
    result = log_vulnerability_to_supabase(
        base_url=test_url,
        vulnerability_type="sql-injection-attempt",
        payload="test payload",
        path="/api/search",
        success=True,
        additional_data={
            "sql_payload": "' OR '1'='1",
            "vulnerable_query": "SELECT * FROM users WHERE username = '' OR '1'='1'"
        }
    )
    
    if result:
        print("‚úÖ Successfully logged generic vulnerability to Supabase!")
        print()
        return True
    else:
        print("‚ùå Failed to log generic vulnerability")
        print()
        return False

def main():
    """Run all tests"""
    print()
    
    # Test 1: Check configuration
    if not test_supabase_connection():
        print()
        print("‚ö†Ô∏è  Supabase not configured. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in .env")
        print("   The red-team-agent will still work, but won't log to Supabase.")
        return
    
    print()
    
    # Test 2: SQL injection logging
    sql_test_result = test_sql_injection_logging()
    
    # Test 3: Generic vulnerability logging
    generic_test_result = test_generic_vulnerability_logging()
    
    # Summary
    print("=" * 60)
    print("Test Summary")
    print("=" * 60)
    print(f"Supabase Configuration: ‚úÖ")
    print(f"SQL Injection Logging: {'‚úÖ' if sql_test_result else '‚ùå'}")
    print(f"Generic Vulnerability Logging: {'‚úÖ' if generic_test_result else '‚ùå'}")
    print()
    
    if sql_test_result and generic_test_result:
        print("üéâ All tests passed! Vulnerability logging is working correctly.")
        print()
        print("You can now:")
        print("1. Run the red-team-agent and it will log SQL injection attempts")
        print("2. View logs in your Supabase dashboard: vulnerability_logs table")
        print("3. Query logs using the dashboard backend API")
    else:
        print("‚ö†Ô∏è  Some tests failed. Check:")
        print("   - Supabase URL and service role key are correct")
        print("   - Network connectivity to Supabase")
        print("   - vulnerability_logs table exists in your database")
        print("   - Service role key has INSERT permissions")
    print()

if __name__ == "__main__":
    main()

