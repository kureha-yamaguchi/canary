{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/shayyahal/canary/deterministic-websites/users-managment/lib/honeypot-config.ts"],"sourcesContent":["// Honeypot configuration\nexport const HONEYPOT_CONFIG = {\n  // Table name in Supabase for SQL Injection Honeypot (Vulnerability ID 1)\n  tableName: 'mock_1_users',\n} as const;\n\n"],"names":[],"mappings":"AAAA,yBAAyB;;;;;AAClB,MAAM,kBAAkB;IAC7B,yEAAyE;IACzE,WAAW;AACb"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/shayyahal/canary/deterministic-websites/users-managment/lib/supabase.ts"],"sourcesContent":["import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\n// Server-side only - no NEXT_PUBLIC prefix\n// Use service role key for server-side operations that bypass RLS\nconst supabaseUrl = process.env.SUPABASE_URL;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n// Only create Supabase client if environment variables are configured\nexport const supabase: SupabaseClient | null = \n  supabaseUrl && supabaseServiceKey\n    ? createClient(supabaseUrl, supabaseServiceKey)\n    : null;\n\n// Database types for vulnerability logging\nexport interface VulnerabilityLog {\n  id?: string;\n  base_url: string;\n  vulnerability_type: string;\n  technique_id: string;\n  timestamp?: string;\n  attacker_id: string;\n  session_id: string;\n}\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,2CAA2C;AAC3C,kEAAkE;AAClE,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;AAC5C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAGzD,MAAM,WACX,eAAe,qBACX,IAAA,yMAAY,EAAC,aAAa,sBAC1B"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/shayyahal/canary/deterministic-websites/users-managment/lib/honeypot-utils.ts"],"sourcesContent":["import { HONEYPOT_CONFIG } from './honeypot-config';\nimport { supabase } from './supabase';\n\nexport type SqlInjectionCheckResult =\n  | { status: 'injection_detected'; payload: string; query: string }\n  | { status: 'suspicious'; payload: string; reason: string }\n  | { status: 'normal'; payload: string };\n\n/**\n * Check if user input contains SQL injection patterns\n */\nexport function checkSqlInjection(input: string): SqlInjectionCheckResult {\n  const payload = input.trim();\n  \n  // SQL injection patterns to detect\n  const sqlInjectionPatterns = [\n    /(['\"`])\\s*(OR|AND)\\s*\\1\\s*=\\s*\\1/i,  // ' OR '1'='1\n    /(['\"`])\\s*(OR|AND)\\s*\\1\\s*=\\s*\\1\\s*--/i,  // ' OR '1'='1'--\n    /(['\"`])\\s*;\\s*DROP\\s+TABLE/i,  // '; DROP TABLE\n    /UNION\\s+SELECT/i,  // UNION SELECT\n    /OR\\s+1\\s*=\\s*1/i,  // OR 1=1\n    /OR\\s+1\\s*=\\s*1\\s*--/i,  // OR 1=1--\n    /'\\s*OR\\s*'1'\\s*=\\s*'1/i,  // ' OR '1'='1\n    /'\\s*OR\\s*'1'\\s*=\\s*'1'\\s*--/i,  // ' OR '1'='1'--\n    /\\/\\*.*\\*\\//,  // SQL comments /* */\n    /--\\s/,  // SQL comments --\n    /;\\s*(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)/i,  // Command chaining\n    /xp_\\w+/i,  // SQL Server extended procedures\n    /EXEC\\s*\\(/i,  // EXEC()\n    /sp_\\w+/i,  // SQL Server stored procedures\n  ];\n\n  // Check for SQL injection patterns\n  for (const pattern of sqlInjectionPatterns) {\n    if (pattern.test(payload)) {\n      // Simulate the vulnerable SQL query (for logging purposes)\n      const vulnerableQuery = `SELECT * FROM ${HONEYPOT_CONFIG.tableName} WHERE username = '${payload}' AND password = '...'`;\n      \n      return {\n        status: 'injection_detected',\n        payload,\n        query: vulnerableQuery,\n      };\n    }\n  }\n\n  // Check for suspicious patterns (less definitive)\n  const suspiciousPatterns = [\n    /['\"`]/,  // Quotes\n    /[;|&]/,  // Command separators\n    /(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)/i,  // SQL keywords\n  ];\n\n  let suspiciousCount = 0;\n  for (const pattern of suspiciousPatterns) {\n    if (pattern.test(payload)) {\n      suspiciousCount++;\n    }\n  }\n\n  if (suspiciousCount >= 2) {\n    return {\n      status: 'suspicious',\n      payload,\n      reason: 'Multiple suspicious patterns detected',\n    };\n  }\n\n  return {\n    status: 'normal',\n    payload,\n  };\n}\n\n/**\n * Map vulnerability types to MITRE ATT&CK technique IDs\n * \n * This honeypot exposes Vulnerability ID 1: \"SQL Injection\"\n * See docs/vulnerability-mapping.txt for complete mapping details.\n * \n * MITRE ATT&CK Technique Mappings:\n * - T1190: Exploit Public-Facing Application - SQL injection attacks\n */\nfunction getTechniqueId(vulnerabilityType: string): string {\n  // T1190: Exploit Public-Facing Application - SQL injection through user input\n  return 'T1190';\n}\n\n/**\n * Generate a session ID from request headers\n */\nfunction getSessionId(request: Request): string {\n  const ip = request.headers.get('x-forwarded-for') ||\n             request.headers.get('x-real-ip') ||\n             'unknown';\n  const timestamp = Date.now();\n  return `${ip.split(',')[0]}_${timestamp}`;\n}\n\n/**\n * Log SQL injection attempt to Supabase database\n */\nexport async function logSqlInjectionAttempt(\n  result: SqlInjectionCheckResult,\n  request: Request,\n  route?: string\n) {\n  const url = new URL(request.url);\n\n  // Map the result status to specific vulnerability types\n  const vulnerabilityType =\n    result.status === 'injection_detected'\n      ? 'sql-injection-attempt'\n      : result.status === 'suspicious'\n      ? 'sql-injection-suspicious'\n      : 'sql-injection-normal';\n\n  // Extract attacker_id (IP address or other identifier)\n  const attackerId =\n    request.headers.get('x-forwarded-for')?.split(',')[0] ||\n    request.headers.get('x-real-ip') ||\n    'unknown';\n\n  // Get session ID for tracking\n  const sessionId = getSessionId(request);\n\n  // Get appropriate MITRE ATT&CK technique ID\n  const techniqueId = getTechniqueId(vulnerabilityType);\n\n  const payload = {\n    base_url: url.origin,\n    vulnerability_type: vulnerabilityType,\n    technique_id: techniqueId,\n    attacker_id: attackerId,\n    session_id: sessionId,\n  };\n\n  // Add additional context for SQL injection\n  if (result.status === 'injection_detected') {\n    (payload as any).sql_payload = result.payload;\n    (payload as any).vulnerable_query = result.query;\n  } else if (result.status === 'suspicious') {\n    (payload as any).sql_payload = result.payload;\n    (payload as any).suspicious_reason = result.reason;\n  }\n\n  console.log('[Honeypot] Attempting to log SQL injection to Supabase:', payload);\n\n  // Check if Supabase is configured\n  if (!supabase) {\n    console.warn('[Honeypot] Supabase not configured - skipping database log. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in .env.local');\n    return;\n  }\n\n  try {\n    const { data, error } = await supabase\n      .from('vulnerability_logs')\n      .insert(payload);\n\n    if (error) {\n      console.error('[Honeypot] Failed to log to Supabase:', error);\n    } else {\n      console.log('[Honeypot] Successfully logged to Supabase:', data);\n    }\n  } catch (err) {\n    console.error('[Honeypot] Exception while logging:', err);\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAUO,SAAS,kBAAkB,KAAa;IAC7C,MAAM,UAAU,MAAM,IAAI;IAE1B,mCAAmC;IACnC,MAAM,uBAAuB;QAC3B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,mCAAmC;IACnC,KAAK,MAAM,WAAW,qBAAsB;QAC1C,IAAI,QAAQ,IAAI,CAAC,UAAU;YACzB,2DAA2D;YAC3D,MAAM,kBAAkB,CAAC,cAAc,EAAE,8IAAe,CAAC,SAAS,CAAC,mBAAmB,EAAE,QAAQ,sBAAsB,CAAC;YAEvH,OAAO;gBACL,QAAQ;gBACR;gBACA,OAAO;YACT;QACF;IACF;IAEA,kDAAkD;IAClD,MAAM,qBAAqB;QACzB;QACA;QACA;KACD;IAED,IAAI,kBAAkB;IACtB,KAAK,MAAM,WAAW,mBAAoB;QACxC,IAAI,QAAQ,IAAI,CAAC,UAAU;YACzB;QACF;IACF;IAEA,IAAI,mBAAmB,GAAG;QACxB,OAAO;YACL,QAAQ;YACR;YACA,QAAQ;QACV;IACF;IAEA,OAAO;QACL,QAAQ;QACR;IACF;AACF;AAEA;;;;;;;;CAQC,GACD,SAAS,eAAe,iBAAyB;IAC/C,8EAA8E;IAC9E,OAAO;AACT;AAEA;;CAEC,GACD,SAAS,aAAa,OAAgB;IACpC,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,sBACpB,QAAQ,OAAO,CAAC,GAAG,CAAC,gBACpB;IACX,MAAM,YAAY,KAAK,GAAG;IAC1B,OAAO,GAAG,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,WAAW;AAC3C;AAKO,eAAe,uBACpB,MAA+B,EAC/B,OAAgB,EAChB,KAAc;IAEd,MAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;IAE/B,wDAAwD;IACxD,MAAM,oBACJ,OAAO,MAAM,KAAK,uBACd,0BACA,OAAO,MAAM,KAAK,eAClB,6BACA;IAEN,uDAAuD;IACvD,MAAM,aACJ,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,IACrD,QAAQ,OAAO,CAAC,GAAG,CAAC,gBACpB;IAEF,8BAA8B;IAC9B,MAAM,YAAY,aAAa;IAE/B,4CAA4C;IAC5C,MAAM,cAAc,eAAe;IAEnC,MAAM,UAAU;QACd,UAAU,IAAI,MAAM;QACpB,oBAAoB;QACpB,cAAc;QACd,aAAa;QACb,YAAY;IACd;IAEA,2CAA2C;IAC3C,IAAI,OAAO,MAAM,KAAK,sBAAsB;QACzC,QAAgB,WAAW,GAAG,OAAO,OAAO;QAC5C,QAAgB,gBAAgB,GAAG,OAAO,KAAK;IAClD,OAAO,IAAI,OAAO,MAAM,KAAK,cAAc;QACxC,QAAgB,WAAW,GAAG,OAAO,OAAO;QAC5C,QAAgB,iBAAiB,GAAG,OAAO,MAAM;IACpD;IAEA,QAAQ,GAAG,CAAC,2DAA2D;IAEvE,kCAAkC;IAClC,IAAI,CAAC,6HAAQ,EAAE;QACb,QAAQ,IAAI,CAAC;QACb;IACF;IAEA,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,6HAAQ,CACnC,IAAI,CAAC,sBACL,MAAM,CAAC;QAEV,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,yCAAyC;QACzD,OAAO;YACL,QAAQ,GAAG,CAAC,+CAA+C;QAC7D;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,uCAAuC;IACvD;AACF"}},
    {"offset": {"line": 204, "column": 0}, "map": {"version":3,"sources":["file:///Users/shayyahal/canary/deterministic-websites/users-managment/app/api/search/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { checkSqlInjection, logSqlInjectionAttempt } from '@/lib/honeypot-utils';\nimport { supabase } from '@/lib/supabase';\nimport { HONEYPOT_CONFIG } from '@/lib/honeypot-config';\n\n/**\n * VULNERABLE API ENDPOINT - SQL Injection Honeypot\n * \n * This endpoint is intentionally vulnerable to SQL injection.\n * User input is directly concatenated into a SQL query without sanitization.\n * \n * DO NOT USE THIS PATTERN IN PRODUCTION CODE!\n */\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const username = body.username || '';\n\n    // Check for SQL injection attempts\n    const injectionCheck = checkSqlInjection(username);\n\n    // Log the attempt to Supabase\n    await logSqlInjectionAttempt(injectionCheck, request, '/api/search');\n\n    // VULNERABLE CODE: Direct string concatenation into SQL query\n    // This is the vulnerability - user input is not sanitized or parameterized\n    // NOTE: We show the vulnerable query pattern, but execute safely using Supabase\n    const vulnerableQuery = `SELECT * FROM ${HONEYPOT_CONFIG.tableName} WHERE username = '${username}' AND active = 1`;\n\n    // Actually query the database using Supabase (safely with parameterized queries)\n    // This demonstrates what the vulnerable query would look like, but executes safely\n    let dbResults: any[] = [];\n    \n    if (supabase) {\n      try {\n        // Use Supabase's safe query method (parameterized) to actually get data\n        // This simulates what would happen if the vulnerable query was executed\n        const { data, error } = await supabase\n          .from(HONEYPOT_CONFIG.tableName)\n          .select('username, email, active')\n          .eq('username', username)\n          .eq('active', true);\n\n        if (!error && data) {\n          dbResults = data;\n        }\n\n        // If SQL injection is detected, also return all active users to show impact\n        if (injectionCheck.status === 'injection_detected') {\n          const { data: allUsers } = await supabase\n            .from(HONEYPOT_CONFIG.tableName)\n            .select('username, email, active')\n            .eq('active', true)\n            .limit(10);\n\n          if (allUsers) {\n            dbResults = allUsers;\n          }\n        }\n      } catch (dbError) {\n        console.error('[Honeypot] Database query error:', dbError);\n      }\n    } else {\n      // Fallback if Supabase not configured\n      if (injectionCheck.status === 'injection_detected') {\n        dbResults = [\n          { username: 'admin', email: 'admin@example.com', active: true },\n          { username: 'user1', email: 'user1@example.com', active: true },\n          { username: 'user2', email: 'user2@example.com', active: true },\n        ];\n      } else if (username.toLowerCase() === 'admin' || username.toLowerCase() === 'test') {\n        dbResults = [{ username, email: `${username}@example.com`, active: true }];\n      }\n    }\n\n    // Format response\n    const response: any = {\n      success: true,\n      query: vulnerableQuery,\n      results: dbResults.map((user: any) => ({\n        username: user.username,\n        email: user.email,\n      })),\n    };\n\n    if (injectionCheck.status === 'injection_detected') {\n      response.warning = 'SQL injection attempt detected and logged';\n      if (dbResults.length > 0) {\n        response.note = `SQL injection successful - returned ${dbResults.length} records (would normally return all records)`;\n      }\n    }\n\n    return NextResponse.json(response);\n  } catch (error) {\n    console.error('Search error:', error);\n    return NextResponse.json(\n      {\n        error: 'An error occurred while searching',\n        details: error instanceof Error ? error.message : 'Unknown error',\n      },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAUO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,WAAW,KAAK,QAAQ,IAAI;QAElC,mCAAmC;QACnC,MAAM,iBAAiB,IAAA,+IAAiB,EAAC;QAEzC,8BAA8B;QAC9B,MAAM,IAAA,oJAAsB,EAAC,gBAAgB,SAAS;QAEtD,8DAA8D;QAC9D,2EAA2E;QAC3E,gFAAgF;QAChF,MAAM,kBAAkB,CAAC,cAAc,EAAE,8IAAe,CAAC,SAAS,CAAC,mBAAmB,EAAE,SAAS,gBAAgB,CAAC;QAElH,iFAAiF;QACjF,mFAAmF;QACnF,IAAI,YAAmB,EAAE;QAEzB,IAAI,6HAAQ,EAAE;YACZ,IAAI;gBACF,wEAAwE;gBACxE,wEAAwE;gBACxE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,6HAAQ,CACnC,IAAI,CAAC,8IAAe,CAAC,SAAS,EAC9B,MAAM,CAAC,2BACP,EAAE,CAAC,YAAY,UACf,EAAE,CAAC,UAAU;gBAEhB,IAAI,CAAC,SAAS,MAAM;oBAClB,YAAY;gBACd;gBAEA,4EAA4E;gBAC5E,IAAI,eAAe,MAAM,KAAK,sBAAsB;oBAClD,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,6HAAQ,CACtC,IAAI,CAAC,8IAAe,CAAC,SAAS,EAC9B,MAAM,CAAC,2BACP,EAAE,CAAC,UAAU,MACb,KAAK,CAAC;oBAET,IAAI,UAAU;wBACZ,YAAY;oBACd;gBACF;YACF,EAAE,OAAO,SAAS;gBAChB,QAAQ,KAAK,CAAC,oCAAoC;YACpD;QACF,OAAO;YACL,sCAAsC;YACtC,IAAI,eAAe,MAAM,KAAK,sBAAsB;gBAClD,YAAY;oBACV;wBAAE,UAAU;wBAAS,OAAO;wBAAqB,QAAQ;oBAAK;oBAC9D;wBAAE,UAAU;wBAAS,OAAO;wBAAqB,QAAQ;oBAAK;oBAC9D;wBAAE,UAAU;wBAAS,OAAO;wBAAqB,QAAQ;oBAAK;iBAC/D;YACH,OAAO,IAAI,SAAS,WAAW,OAAO,WAAW,SAAS,WAAW,OAAO,QAAQ;gBAClF,YAAY;oBAAC;wBAAE;wBAAU,OAAO,GAAG,SAAS,YAAY,CAAC;wBAAE,QAAQ;oBAAK;iBAAE;YAC5E;QACF;QAEA,kBAAkB;QAClB,MAAM,WAAgB;YACpB,SAAS;YACT,OAAO;YACP,SAAS,UAAU,GAAG,CAAC,CAAC,OAAc,CAAC;oBACrC,UAAU,KAAK,QAAQ;oBACvB,OAAO,KAAK,KAAK;gBACnB,CAAC;QACH;QAEA,IAAI,eAAe,MAAM,KAAK,sBAAsB;YAClD,SAAS,OAAO,GAAG;YACnB,IAAI,UAAU,MAAM,GAAG,GAAG;gBACxB,SAAS,IAAI,GAAG,CAAC,oCAAoC,EAAE,UAAU,MAAM,CAAC,4CAA4C,CAAC;YACvH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}